# Setup Guide

Complete walkthrough to get slack-dev-bot running on your server.

## What you'll need

- A **Linux server** (Ubuntu/Debian recommended) — any VPS works (Hetzner, DigitalOcean, AWS, etc.)
- A **GitHub account** with access to your org's repos
- A **Slack workspace** where you're an admin (to create apps)
- An **LLM CLI tool** — see Step 1 below for options

Optional:
- **OpenRouter API key** — for hybrid LLM mode (Gemini pre-processing)
- **Linear API key** — for ticket activity summaries
- **Notion API key** — for auto-generated context from spec pages

Total setup time: ~20 minutes (core), ~10 more for optional integrations.

---

## Step 1: Server prerequisites

SSH into your server and install the required tools.

### Node.js 18+

```bash
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt install -y nodejs
node --version  # should show v22.x
```

Node 18+ is required for built-in `fetch()`.

### GitHub CLI

```bash
sudo apt install -y gh
gh auth login
# Choose: GitHub.com → HTTPS → Login with a web browser
# Follow the prompts to authenticate
```

Verify access to your org:
```bash
gh api orgs/YOUR-ORG-NAME/repos --jq '.[].name'
```

### LLM CLI tool

The bot needs a command-line tool that accepts a prompt via stdin and returns the response. You have several options:

**Option A: Claude Code CLI (recommended)**
```bash
npm install -g @anthropic-ai/claude-code
echo 'export ANTHROPIC_API_KEY="sk-ant-your-key-here"' >> ~/.bashrc
source ~/.bashrc
```
Config: `"llmCommand": "claude -p -"`

**Option B: OpenAI via llm CLI**
```bash
pip install llm
llm keys set openai  # paste your API key
```
Config: `"llmCommand": "llm -m gpt-4o"`

**Option C: Ollama (local, free)**
```bash
curl -fsSL https://ollama.com/install.sh | sh
ollama pull llama3.1
```
Config: `"llmCommand": "ollama run llama3.1"`

**Option D: Any custom command**
Any command that reads a prompt from stdin and writes the response to stdout works. For example, a wrapper script:
```bash
#!/bin/bash
curl -s https://api.example.com/chat -d @-
```
Config: `"llmCommand": "/path/to/your-script.sh"`

**Test your choice:**
```bash
echo "Say hello in one sentence" | your-command-here
```

### Other tools

```bash
sudo apt install -y jq curl
```

---

## Step 2: Clone and configure

```bash
cd ~  # or wherever you keep projects
git clone https://github.com/manndmt-jpg/slack-dev-bot.git
cd slack-dev-bot
```

### Create your config

```bash
cp config.example.json config.json
```

Edit `config.json`:

```json
{
  "org": "your-github-org",
  "extraRepos": [],
  "llmCommand": "claude -p -",
  "slackWebhookUrl": "...",
  "slackBotToken": "xoxb-...",
  "slackAppToken": "xapp-...",
  "ticketPattern": "PROJ-\\d+",
  "authorMap": {
    "github-username": "Display Name"
  },
  "linearTeamId": "",
  "linearOrg": "your-linear-org",
  "linearSlackWebhookUrl": "",
  "linearAuthorMap": {},
  "notionDatabaseId": ""
}
```

**Core fields:**

| Field | What to put |
|---|---|
| `org` | Your GitHub organization name (from the URL: github.com/**your-org**) |
| `extraRepos` | Repos outside your org to also scan, e.g. `["other-org/some-repo"]`. Leave `[]` if not needed |
| `llmCommand` | CLI command that reads a prompt from stdin and writes response to stdout. See Step 1 for options |
| `slackWebhookUrl` | From Step 3 below |
| `slackBotToken` | From Step 3 below (starts with `xoxb-`) |
| `slackAppToken` | From Step 3 below (starts with `xapp-`) |
| `ticketPattern` | Regex for your ticket IDs in commit messages. Examples: `PROJ-\\d+`, `JIRA-\\d+`, `#\\d+`. Leave `""` to skip |
| `authorMap` | Maps GitHub usernames to display names. Find usernames from your team's GitHub profiles |

**Optional fields (leave empty to skip):**

| Field | What to put |
|---|---|
| `linearTeamId` | Your Linear team UUID. Find it: Linear Settings → Team → copy the ID from the URL |
| `linearOrg` | Your Linear org slug (used for URLs, e.g. `your-org` from `linear.app/your-org`) |
| `linearSlackWebhookUrl` | Slack webhook for a separate Linear activity channel |
| `linearAuthorMap` | Maps Linear display names to short names. Linear usernames differ from GitHub |
| `notionDatabaseId` | Notion database ID for spec pages (from the URL) |

### Create your context file

```bash
cp context.example.md context.md
```

Edit `context.md` with details about your project. This is optional but **strongly recommended** — it's what turns generic commit-message parroting into actually useful summaries.

The file has a marker line `<!-- AUTO-GENERATED BELOW -->`. Everything above it is your static context (edit manually). Everything below gets auto-generated by `build-context.js` if you set up Linear/Notion.

### Why context matters

Without context, the LLM only sees raw commit messages like:
> `fix: update FNOL fractional state`

It doesn't know what FNOL means, what "fractional" refers to, or why it matters. With context, it can produce:
> *Yegor — fixed the multi-step claim reporting flow so users can edit individual answers*

### What to include

| Section | Why it helps | Example |
|---|---|---|
| **Company/product** | The LLM understands the domain | "Acme builds a SaaS platform for fleet management" |
| **Repositories** | Knows what each repo does | "vehicle-api — REST API for vehicle tracking and telemetry" |
| **Team members** | Groups work by expertise | "Alice — backend, payment integrations" |
| **Terminology** | Translates jargon in commit messages | "ELD = Electronic Logging Device (driver hours tracking)" |
| **Current priorities** | Improves the "Notable" summary line | "Q1 focus: real-time GPS tracking and ELD compliance" |
| **Ticket pattern** | Extracts ticket references | "Tickets follow FLEET-xxx from Linear" |

### Tips for writing good context

- **Be specific about repos.** "backend stuff" is useless. "Express API serving the mobile app and admin dashboard, handles auth, fleet CRUD, and webhooks from GPS devices" is useful.
- **Explain acronyms and internal names.** Every team has shorthand that makes no sense to outsiders. If people write "fix PDI flow" in commits, explain what PDI means.
- **Update it when priorities change.** The "Notable" summary line uses current priorities to highlight what matters. Stale priorities = irrelevant highlights.
- **List what people work on, not their job titles.** "Senior Engineer" tells the LLM nothing. "Works on payment integration and billing" helps it group and describe their commits.

### Iterate

Run a dry-run, read the summary, and ask: "Did it misunderstand anything?" If yes, add clarification to `context.md` and rerun. Usually takes 1-2 rounds to get right.

---

## Step 3: Create a Slack app

Go to **https://api.slack.com/apps** and click **Create New App** → **From scratch**.

- **App Name:** whatever you want (e.g. "Dev Bot")
- **Workspace:** your Slack workspace

### 3a. Enable Socket Mode

1. Left sidebar → **Socket Mode**
2. Toggle **Enable Socket Mode** → ON
3. It asks you to create an App-Level Token:
   - Token Name: `socket-token`
   - Add scope: `connections:write`
   - Click **Generate**
4. **Copy the token** (starts with `xapp-`) → paste into `config.json` as `slackAppToken`

### 3b. Set up events

1. Left sidebar → **Event Subscriptions**
2. Toggle **Enable Events** → ON
3. Expand **Subscribe to bot events**
4. Click **Add Bot User Event** and add:
   - `app_mention`
   - `message.channels`
5. Click **Save Changes**

### 3c. Set up permissions

1. Left sidebar → **OAuth & Permissions**
2. Scroll to **Bot Token Scopes**
3. Add these scopes:
   - `app_mentions:read`
   - `channels:history`
   - `channels:read`
   - `chat:write`
4. Scroll back up and click **Install to Workspace** (or **Reinstall** if updating)
5. Click **Allow**
6. **Copy the Bot User OAuth Token** (starts with `xoxb-`) → paste into `config.json` as `slackBotToken`

### 3d. Create incoming webhooks

1. Left sidebar → **Incoming Webhooks**
2. Toggle **Activate Incoming Webhooks** → ON
3. Click **Add New Webhook to Workspace**
4. Select the channel for daily git summaries (e.g. `#dev-summary`)
5. Click **Allow**
6. **Copy the Webhook URL** → paste into `config.json` as `slackWebhookUrl`

If using Linear summaries, create a second webhook for a separate channel (e.g. `#linear-activity`) and paste it as `linearSlackWebhookUrl`.

### 3e. Invite the bot to your channels

In Slack:
```
/invite @YourBotName
```

---

## Step 4: Build your author map

This is an important step. GitHub usernames often don't match real names, and people sometimes commit from multiple accounts.

### Find all committers

Check your org's members page:
```
https://github.com/orgs/YOUR-ORG/people
```

Or run this to discover all usernames that have been committing recently:
```bash
gh api orgs/YOUR-ORG/repos --paginate --jq '.[].name' | while read repo; do
  gh api "repos/YOUR-ORG/$repo/commits?per_page=10" \
    --jq '.[] | .author.login // .commit.author.name' 2>/dev/null
done | sort -u
```

### Map usernames to display names

Add each username to the `authorMap` in `config.json`:
```json
"authorMap": {
  "alice-gh": "Alice",
  "bob123": "Bob",
  "charlie-dev": "Charlie"
}
```

### Watch for alt accounts

Some team members commit from multiple GitHub accounts (personal vs work). If you see an unfamiliar username, look up the commit email:

```bash
gh api repos/YOUR-ORG/REPO/commits/COMMIT_SHA \
  --jq '{login: .author.login, name: .commit.author.name, email: .commit.author.email}'
```

If the email matches a known team member, add the alt username to the map.

### Linear author map (optional)

If using Linear, you'll need a separate map since Linear usernames differ from GitHub:

```json
"linearAuthorMap": {
  "alice.smith": "Alice",
  "bob-dev": "Bob"
}
```

### Iterate after first run

Run `node git-summary.js --dry-run --hours=168` (7 days) to see a week of activity. Check the raw data for unmapped usernames, then update your author map. Usually takes 1-2 iterations to catch everyone.

---

## Step 5: Optional integrations

### Hybrid LLM mode (OpenRouter)

When `OPENROUTER_API_KEY` is set, scripts use a two-stage pipeline:
1. **Gemini Flash** ($0.30/M input) pre-processes raw data — groups by person/ticket, identifies themes
2. **Your configured LLM** only formats the polished output into Slack mrkdwn

This produces better summaries at lower cost. Without it, raw data goes directly to your LLM.

```bash
# Get a key at https://openrouter.ai/keys
export OPENROUTER_API_KEY="sk-or-..."
```

### Linear integration

1. Get a Linear API key: Linear Settings → API → Personal API keys
2. Find your team ID: go to your team's page in Linear, the UUID is in the URL
3. Set the environment variable and config fields:

```bash
export LINEAR_API_KEY="lin_api_..."
```

```json
{
  "linearTeamId": "abba2c0d-256b-4a83-bb38-77b86f468f5f",
  "linearOrg": "your-org",
  "linearSlackWebhookUrl": "https://hooks.slack.com/services/...",
  "linearAuthorMap": {
    "linear-username": "Display Name"
  }
}
```

Test: `node linear-summary.js --dry-run --hours=48`

### Notion integration

1. Create an integration at https://www.notion.so/my-integrations
2. Share your specs database with the integration
3. Set the environment variable and config field:

```bash
export NOTION_API_KEY="ntn_..."
```

```json
{
  "notionDatabaseId": "28ddf45b-20fd-805a-bee6-c85c56ff9deb"
}
```

Test: `node build-context.js --dry-run`

### Environment variables on your server

Add to `~/.profile` (not `~/.bashrc` — cron and non-interactive shells may not load bashrc):

```bash
export OPENROUTER_API_KEY="sk-or-..."
export LINEAR_API_KEY="lin_api_..."
export NOTION_API_KEY="ntn_..."
```

Also add them to your crontab header:

```bash
crontab -e
```

```
OPENROUTER_API_KEY=sk-or-...
LINEAR_API_KEY=lin_api_...
NOTION_API_KEY=ntn_...

50 5 * * 1-5 /usr/bin/node /path/to/build-context.js >> /path/to/logs/context.log 2>&1
0  6 * * 1-5 /usr/bin/node /path/to/git-summary.js   >> /path/to/logs/cron.log 2>&1
2  6 * * 1-5 /usr/bin/node /path/to/linear-summary.js >> /path/to/logs/linear.log 2>&1
```

---

## Step 6: Run setup

```bash
bash setup.sh
```

This checks prerequisites, installs dependencies, runs a dry-run test, and optionally sets up:
- A **systemd service** for the interactive bot (keeps it running 24/7)
- A **cron job** for the daily summary (default: Mon-Fri at 7:00 UTC)

### Or do it manually

Install deps:
```bash
npm install
```

Test the summary:
```bash
node git-summary.js --dry-run
```

Start the bot:
```bash
node bot.js
```

---

## Step 7: Customize the schedule

The setup script creates a cron at 7:00 UTC. To change it:

```bash
crontab -e
```

Recommended schedule with all features:
```
50 5 * * 1-5 /usr/bin/node /path/to/build-context.js  >> /path/to/logs/context.log 2>&1
0  6 * * 1-5 /usr/bin/node /path/to/git-summary.js    >> /path/to/logs/cron.log 2>&1
2  6 * * 1-5 /usr/bin/node /path/to/linear-summary.js >> /path/to/logs/linear.log 2>&1
```

Context builds at 5:50 (fresh data before summaries), git at 6:00, Linear at 6:02 (staggered to avoid concurrent LLM calls).

Common schedules:
| Schedule | Cron | UTC note |
|---|---|---|
| 8:00 AM CET (Berlin winter) | `0 7 * * 1-5` | CET = UTC+1 |
| 9:00 AM EST (New York winter) | `0 14 * * 1-5` | EST = UTC-5 |
| 9:00 AM PST (SF winter) | `0 17 * * 1-5` | PST = UTC-8 |

---

## Verify it works

### Test the git summary
```bash
node git-summary.js --dry-run
node git-summary.js --dry-run --hours=168  # last 7 days
```

### Test the Linear summary (if configured)
```bash
node linear-summary.js --dry-run --hours=48
```

### Test the context builder (if configured)
```bash
node build-context.js --dry-run
```

### Test the bot
In your Slack channel:
```
@YourBotName what did the team work on recently?
```

The bot should react with eyes while thinking, then respond in a thread.

### Check service status
```bash
systemctl status slack-dev-bot
journalctl -u slack-dev-bot --since "10 min ago"
```

### Check cron output
```bash
cat logs/cron.log
cat logs/linear.log
cat logs/context.log
```

---

## Troubleshooting

**"No activity found"** — your lookback window might be too short, or the org name is wrong. Try `--hours=168` for a week of data.

**"gh: Not Found"** — your GitHub token doesn't have access to the org. Re-run `gh auth login` and ensure you have the `read:org` and `repo` scopes.

**Bot doesn't respond in Slack** — check that Socket Mode is enabled, the bot is invited to the channel, and `app_mention` event is subscribed. Check logs: `journalctl -u slack-dev-bot -f`

**"Empty summary from LLM"** — your LLM command might not be in PATH or the API key isn't set. Test with: `echo "Say hello" | your-llm-command`

**"OpenRouter error"** — check your `OPENROUTER_API_KEY` is valid. The hybrid LLM mode is optional — scripts fall back to sending raw data to your LLM if Gemini fails.

**"LINEAR_API_KEY not set"** — if you don't use Linear, leave `linearTeamId` empty and don't run `linear-summary.js`. The bot and context builder skip Linear gracefully.

**Cron runs but nothing posts** — check log files. Common issue: cron doesn't load your shell profile, so environment variables and CLI tools aren't available. Add API keys to the crontab header and use full paths (e.g. `/usr/bin/node`).

**Stale PRs appearing** — `git-summary.js` only includes PRs created, merged, or closed in the time window. It deliberately ignores `updatedAt` because bots (CI, Vercel, etc.) constantly bump it.
